{% extends base.html %}

{% block head %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script> !window.jQuery && document.write('<script src=\"{{static_url("js/jquery-1.4.3.min.js")}}\"><\/script>'); </script>
<script type="text/javascript" src="{{static_url('js/fancybox/jquery.fancybox-1.3.4.pack.js')}}"></script>
<link rel="stylesheet" href="{{static_url('js/fancybox/jquery.fancybox-1.3.4.css')}}" type="text/css" media="screen" />
{% end %}

{% block body %}
  <div id="layout-background">
    <div class="logo">
      <div class="text">
        <span id="text-loli">LOLI</span><span id="text-dot">・</span>
      </div>
      <span id="text-lu">撸</span>
    </div>
  </div>
  <div id="layout-info">
      <div class="info-box">{% block info %}{% end %}</div>
  </div>
  <div id="layout-list">{% block list %}{% end %}</div>
  <div class="clearfix"><div>
{% end %}

{% block info %}
    {% include info.html %}
{% end %}

{% block list %}
<div class="add-task-box">
  <div class="add-task">
    <input name="task-url" id="task-url" />
    <div class="add-task-bottom">+</div>
  </div>
</div>
<ul class="task-list">
  <li class="push-top"></li>
  {% raw modules.TaskItems(tasks) %}
  <li class="push-bottom"></li>
</ul>
{% end %}

{% block foot %}
<script>
  function _gc(name) {
    return document.getElementsByClassName(name);
  }
  var OnResize = function() {
    var tnames = _gc("tname");
    for(var i=0; i<tnames.length; i++) {
      var tname = tnames[i];
      if (tnames[i].offsetWidth-200 < tnames[i].firstChild.offsetWidth) {
        tnames[i].lastChild.setAttribute("style", "right: 0;");
      } else {
        tnames[i].lastChild.removeAttribute("style");
      }
    }
  }
  OnResize();
  window.onresize = OnResize;

  //load next page
  $(".task-list").bind("scroll", function() {
    if ($(".task-list .push-bottom").offset().top  < $(window).height() * 1.2) {
      // load next page
      $.get("/next",
            {s: $(".task-item:last").attr("data-task-id")},
            function(content) {
              if ($.trim(content) == "") {
                $(".task-list").unbind("scroll");
              } else {
                $(".task-list .push-bottom").before(content);
              }
            });
    }
  });

  //get lixian url fancybox
  $(".get-lixian-url").fancybox({ width: 700 });

  //add task
  $(".add-task-bottom").click(function() {
    if ($(".add-task-bottom").text() == "O") {
       return false;
    }
    if ($(".add-task-box").attr("class").indexOf("show") != -1) {
      if($(".add-task input").val() != "") {
        $(".add-task-bottom").text("O");
        $.ajax({
          type: "post",
          url: "/add_task",
          data: {
            url: $(".add-task input").val()
          },
          dataType: "json",
          success: function(data) {
            if (data.result) {
              location.reload();
            } else {
              $(".add-task-bottom").text("X");
              $(".add-task input").val("");
              $(".add-task-box, .add-task input").removeClass("show");
            }
          },
        });
      } else {
        $(".add-task-box, .add-task input").removeClass("show");
      }
    } else {
      $(".add-task-bottom").text("+");
      $(".add-task-box, .add-task input").addClass("show");
    }
  });
</script>
{% end %}
